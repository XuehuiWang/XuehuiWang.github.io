<!DOCTYPE html><html lang="zh-CN,default,default"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> deserialize numeric string for map key in json · play a litle more!</title><meta name="description" content="deserialize numeric string for map key in json - windpuller"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://windpuller.github.io/blog/atom.xml" title="play a litle more!"></head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/windpuller" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">deserialize numeric string for map key in json</h1><div class="post-info">2016年2月28日</div><div class="post-content"><p>最近反序列化json的时候，踩到了一个jackson转换map key的坑。踩坑时反序列化的数据格式如下:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"1"</span>: <span class="string">"观景"</span>,</span><br><span class="line">    <span class="attr">"2"</span>: <span class="string">"小资"</span>,</span><br><span class="line">    <span class="attr">"3"</span>: <span class="string">"院落"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"ret"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"errcode"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后使用如下代码对其进行反序列化：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String retStr = <span class="string">"&#123;<span class="subst">\"</span>data<span class="subst">\"</span>:&#123;<span class="subst">\"</span>1<span class="subst">\"</span>:<span class="subst">\"</span>观景<span class="subst">\"</span>,<span class="subst">\"</span>2<span class="subst">\"</span>:<span class="subst">\"</span>小资<span class="subst">\"</span>,<span class="subst">\"</span>3<span class="subst">\"</span>:<span class="subst">\"</span>院落<span class="subst">\"</span>&#125;,<span class="subst">\"</span>ret<span class="subst">\"</span>:true,<span class="subst">\"</span>errcode<span class="subst">\"</span>:0&#125;"</span>;</span><br><span class="line">ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">Map&lt;String, Object&gt; retMap = objectMapper.readValue(retStr, new TypeReference&lt;Map&lt;String, Object&gt;&gt;()&#123;&#125;);</span><br><span class="line">Map&lt;Integer, String&gt; dataMap = (Map&lt;Integer, String&gt;) retMap.get(<span class="string">"data"</span>);</span><br></pre></td></tr></table></figure></p>
<p>之后针对一些数字，需要判断dataMap中是否存在这个key，这里调用的是Map的containsKey()方法：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">boolean existing</span> = dataMap.containsKey(1);</span><br></pre></td></tr></table></figure></p>
<p>明明dataMap中存在key=1的键值对，但是得到的结果却是false。<br>此时debug查看dataMap的内容(如下)，发现dataMap中是存在key=1的键值对的。但是查看key的类型，并不是int而是char，而上边调用constainsKey()方法传入的参数是int，因此返回false。<br><img src="/blog/2016/02/28/deserialize-numeric-string-for-map-key-in-json/image01.png" alt="cast_numeric_string_to_Integer01.png"><br>深扒了一下jackson的底层代码，发现它在反序列化map的key的时候，如果没有明确指定key的类型，将默认按照String类型处理，最终调用的是<code>StringKD</code>的<code>_parse</code>方法，直接将json中的数字以字符串的形式返回了。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> static <span class="class"><span class="keyword">class</span> <span class="title">StringKD</span> <span class="keyword">extends</span> <span class="title">StdKeyDeserializer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">String</span> _parse(<span class="type">String</span> key, <span class="type">DeserializationContext</span> ctxt) <span class="keyword">throws</span> <span class="type">JsonMappingException</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改代码如下，显式地将key转化为Integer类型，我们得到了想要的结果。<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span> retStr = <span class="string">"&#123;\"</span>data\<span class="string">":&#123;\"</span><span class="number">1</span>\<span class="string">":\"</span>观景\<span class="string">",\"</span><span class="number">2</span>\<span class="string">":\"</span>小资\<span class="string">",\"</span><span class="number">3</span>\<span class="string">":\"</span>院落\<span class="string">"&#125;,\"</span>ret\<span class="string">":true,\"</span>errcode\<span class="string">":0&#125;"</span>;</span><br><span class="line">ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">Map&lt;<span class="built_in">String</span>, Object&gt; retMap = objectMapper.readValue(retStr, <span class="keyword">new</span> TypeReference&lt;Map&lt;<span class="built_in">String</span>, Object&gt;&gt;()&#123;&#125;);</span><br><span class="line">Map&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; dataMap = (Map&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;) retMap.<span class="keyword">get</span>(<span class="string">"data"</span>);</span><br><span class="line">Map&lt;Integer, <span class="built_in">String</span>&gt; tempMap = Maps.newHashMapWithExpectedSize(dataMap.size());</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; entry : dataMap.entrySet()) &#123;</span><br><span class="line">    tempMap.put(Integer.valueOf(entry.getKey()), entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line">boolean existing = tempMap.containsKey(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<p>当然还有另外一种解决方案，就是用明确了数据类型的类(即下面的<code>AjaxResult</code>)去接收反序列化的结果，代码如下，这个时候jackson知道了map key的类型，直接调用了<code>IntKD</code>的<code>_parse</code>，将字符串转化为Integer之后返回。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AjaxResult</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> boolean ret;</span><br><span class="line">    <span class="keyword">private</span> int errcode;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, String&gt; <span class="keyword">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> boolean isRet() &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AjaxResult setRet(boolean ret) &#123;</span><br><span class="line">        <span class="keyword">this</span>.ret = ret;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> int getErrcode() &#123;</span><br><span class="line">        <span class="keyword">return</span> errcode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AjaxResult setErrcode(int errcode) &#123;</span><br><span class="line">        <span class="keyword">this</span>.errcode = errcode;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Integer, String&gt; getData() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AjaxResult setData(Map&lt;Integer, String&gt; <span class="keyword">data</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">data</span> = <span class="keyword">data</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AjaxResult ajaxResult = objectMapper.readValue(retStr, <span class="literal">new</span> TypeReference&lt;AjaxResult&gt;() &#123;&#125;);</span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">Integer</span>, <span class="built_in">String</span>&gt; ajaxDataMap = ajaxResult.getData();</span><br><span class="line">dataNodeMap.containsKey(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/blog/2016/05/17/RESTful-note/" class="prev">prev_post</a><a href="/blog/2016/01/17/mount-partitions-on-startup-in-archlinux/" class="next">next_post</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://windpuller.github.io/blog">windpuller</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>